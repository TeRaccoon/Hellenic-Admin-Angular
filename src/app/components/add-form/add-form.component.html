<div class="container" [class]="formVisible">
    <div [class]="fullscreen() ? 'content-fullscreen content' : 'content'">
        <div class="header-section">
            <h1>Adding...</h1>
            <a (click)="hide()">
                <fa-icon class="fa-icon" [icon]="faX" />
            </a>
        </div>
        <div class="content-section">
            <div *ngIf="error && submissionEnded" class="error-section">{{ error }}</div>
            <ng-container *ngIf="formData && loaded else loading">
                <form [formGroup]="addForm" class="form-container">
                    <h1 *ngIf="fullscreen()">{{ 'Adding Invoices' }}</h1>
                    <ng-container *ngFor="let key of mappedFormDataKeys">
                        <div *ngIf="canDisplayInputField(key)" class="input-container" [ngClass]="mappedFormData.get(key)?.inputType">
                            <div class="label-container">
                                <label>{{ key }}<fa-icon *ngIf="mappedFormData.get(key)?.required" class="asterisk" [icon]="faAsterisk" /></label>
                                <label class="label-link" *ngIf="key == 'Delivery Address' || key =='Billing Address'" (click)="addressNotListed(key)"><a>Address not listed?</a></label>
                            </div>
                            <ng-container *ngIf="autoGeneratedReplacement[mappedFormData.get(key)!.fields] !== undefined else notAutoGenerated">
                                <input [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" type="text" [(ngModel)]="autoGeneratedReplacement[mappedFormData.get(key)!.fields].value" [formControlName]="mappedFormData.get(key)!.fields">
                            </ng-container>
                            <ng-template #notAutoGenerated>
                                <ng-container [ngSwitch]="mappedFormData.get(key)?.inputType">
                                    <label *ngSwitchCase="'file'" class="file-upload">
                                        <input [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" accept="image/*" [type]="mappedFormData.get(key)!.inputType" (change)="primeImage($event)">
                                        <fa-icon [ngClass]="file == null ? '' : 'success'" [icon]="faCloudUpload" /> {{ file == null ? "Upload Image" : file.name }}
                                    </label>
                                    <ng-container *ngSwitchCase="'alternative-select'">
                                        <input autocomplete="off" [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" [disabled]="disabled" (input)="filterDropSelect(key, $event, mappedFormData.get(key)!.fields)" type="text" [id]="key" (focus)="onInputFocus(key)" (blur)="onInputBlur(key)"
                                            [value]="alternativeSelectedData[key].selectData">
                                        <div class="drop-select" [ngClass]="selectOpen[key]?.opened ? 'input-visible' : 'input-hidden'">
                                            <p *ngFor="let option of alternativeSelectData[key].data" (click)="updateAlternativeSelectData(mappedFormData.get(key)!.fields, option, key)">{{ option }}</p>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'select'">
                                        <select [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" class="select-input" [formControlName]="mappedFormData.get(key)!.fields">
                                            <option hidden disabled selected value> -- Select an option -- </option>
                                            <option *ngFor="let data of selectDataFromKey(key); let optionKey = index" [selected]="optionKey == 0">{{ data }}</option>
                                        </select>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'replacement'">
                                        <ng-container *ngIf="(key == 'Delivery Address' || key == 'Billing Address') && addressNotListedKeys.includes(key) else standardSelect">
                                            <div class="input-container">
                                                <label>Line 1</label>
                                                <input class="text" type="text" (input)="updateAddressValues(key, 'line1', $event)">
                                            </div>
                                            <div class="input-container">
                                                <label>Line 2</label>
                                                <input class="text" type="text" (input)="updateAddressValues(key, 'line2', $event)">
                                            </div>
                                            <div class="input-container">
                                                <label>Line 3</label>
                                                <input class="text" type="text" (input)="updateAddressValues(key, 'line3', $event)">
                                            </div>
                                            <div class="input-container">
                                                <label>Postcode</label>
                                                <input class="text" type="text" (input)="updateAddressValues(key, 'postcode', $event)">
                                            </div>
                                            <div class="form-footer">
                                                <button class="button" type="button" (click)="addAddressToBook(key)">Add</button>
                                            </div>
                                        </ng-container>
                                        <ng-template #standardSelect>
                                            <div class="drop-select-container">
                                                <input autocomplete="off" [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" [disabled]="disabled" (input)="filterDropSelect(key, $event, null)" type="text" (focus)="onInputFocus(key)" (blur)="onInputBlur(key)" [value]="selectedReplacementData[key]?.selectData">
                                                <div class="drop-select" [ngClass]="selectOpen[key]?.opened ? 'input-visible' : 'input-hidden'">
                                                    <p *ngFor="let option of filteredReplacementData[key].data" (click)="updateSelectedReplacementDataFromKey(option.id, option.replacement, key, mappedFormData.get(key)!.fields, false)">{{ option.replacement }}</p>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'textarea'">
                                        <textarea [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" [formControlName]="mappedFormData.get(key)!.fields"></textarea>
                                    </ng-container>
                                    <input *ngSwitchDefault [class]="inputHasError(mappedFormData.get(key)!.fields) ? 'error-input' : ''" [type]="mappedFormData.get(key)!.inputType" [formControlName]="mappedFormData.get(key)!.fields">
                                </ng-container>
                            </ng-template>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="tableName == 'retail_items'">
                        <div class="image-upload-container">
                            <input accept="image/*" type="file" (change)="primeImage($event)">
                            <fa-icon [icon]="faCloudUpload" [ngClass]="file == null ? '' : 'success'" /> Drop Image Here to Upload
                            <button class="button" (click)="submitImageOnly()">Upload</button>
                        </div>
                    </ng-container>
                    <div class="form-footer">
                        <ng-container *ngIf="tableName != 'invoices' else invoicedItems">
                            <button class="button" (click)="formSubmit(true)" type="submit">Submit</button>
                        </ng-container>
                        <ng-template #invoicedItems>
                            <button class="button" [ngClass]="invoiceCreated ? 'button-success' : ''" (click)="formSubmit(false)" type="submit">
                                <ng-container *ngIf="invoiceCreated else invoiceNotCreated">
                                    <fa-icon [icon]="faCheck" />
                                </ng-container>
                                <ng-template #invoiceNotCreated>
                                    Create
                                </ng-template>
                            </button>
                        </ng-template>
                    </div>
                </form>
                <ng-container *ngIf="tableName == 'invoices'">
                    <form class="form-container" [formGroup]="addInvoicedItemForm">
                        <h1>Add Invoiced Items</h1>
                        <div class="input-container replacement">
                            <label>Item Name <fa-icon class="asterisk" [icon]="faAsterisk" /></label>
                            <div class="drop-select-container">
                                <input (input)="filterDropSelect('Item ID', $event, null)" type="text" (focus)="onInputFocus('Item ID')" (blur)="onInputBlur('Item ID')" [value]="selectedReplacementData['Item ID']?.selectData" formControlName="item_id">
                                <div class="drop-select" [ngClass]="selectOpen['Item ID']?.opened ? 'input-visible' : 'input-hidden'" required>
                                    <p *ngFor="let option of filteredReplacementData['Item ID'].data" (click)="updateSelectedReplacementDataFromKey(option.id, option.replacement, 'Item ID', 'item_id', true)">{{ option.replacement }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="input-container number">
                            <label>Quantity <fa-icon class="asterisk" [icon]="faAsterisk" /></label>
                            <input class="number" type="number" formControlName="quantity">
                        </div>
                        <div class="input-container number">
                            <label>Discount</label>
                            <input class="number" type="number" formControlName="discount">
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <th>Item Name</th>
                                    <th>Quantity</th>
                                    <th>Discount</th>
                                </thead>
                                <tbody *ngIf="invoicedItemsList.length > 0">
                                    <tr *ngFor="let invoicedItem of invoicedItemsList; let index = index">
                                        <td>{{ invoicedItem.name }}</td>
                                        <td>{{ invoicedItem.quantity }}</td>
                                        <td>{{ invoicedItem.discount }}</td>
                                        <td (click)="deleteRow(invoicedItemsList[index].id)">
                                            <fa-icon [icon]="faX" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="form-footer">
                            <button *ngIf="tableName == 'invoices'" (click)="addInvoicedItem($event)" class="button">Add invoiced items</button>
                            <button (click)="close()" class="button">Save</button>
                        </div>
                    </form>
                </ng-container>
            </ng-container>
            <ng-template #loading>
                <div class="loading-container">
                    <fa-icon class="loading-icon" [icon]="faSpinner" spinPulse [spin]="true" />
                </div>
            </ng-template>
        </div>
    </div>
</div>