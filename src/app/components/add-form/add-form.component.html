<div class="container" [class]="formVisible">
    <div [class]="fullscreen() ? 'content-fullscreen content' : 'content'">
        <div class="header-section">
            <h1>Adding...</h1>
            <a (click)="hide()">
                <fa-icon class="icons.fa-icon" [icon]="icons.faX" />
            </a>
        </div>
        <div class="content-section">
            <ng-container *ngIf="formData && formState.loaded else loading">
                <form [formGroup]="addForm" class="form-container">
                    <h1 *ngIf="fullscreen()">{{ 'Adding Invoices' }}</h1>
                    <div *ngIf="formState.error && formState.submitted" class="error-section">{{ formState.error }}
                    </div>
                    <ng-container *ngIf="tableName == 'invoices'">
                        <div class="input-container">
                            <label>Sale type</label>
                            <select (change)="changeSaleType($event)" class="select-input">
                                <option [selected]="saleType == SaleType.Invoice">{{ SaleType.Invoice }}</option>
                                <option [selected]="saleType == SaleType.Cash">{{ SaleType.Cash }}</option>
                            </select>
                        </div>
                    </ng-container>
                    <ng-container *ngFor="let key of mappedFormDataKeys">
                        <div *ngIf="canDisplayInputField(key)" class="input-container"
                            [ngClass]="mappedFormData.get(key)?.inputType">
                            <div class="label-container">
                                <label>{{ key }}<fa-icon *ngIf="mappedFormData.get(key)?.required" class="asterisk"
                                        [icon]="icons.faAsterisk" /></label>
                                <label class="label-link"
                                    *ngIf="(key == 'Delivery Address' || key =='Billing Address') && !addressNotListedKeys.includes(key)"
                                    (click)="addressNotListed(key)"><a>Address not listed?</a></label>
                                <label class="label-link" *ngIf="key == 'Customer Name' && tableName == 'invoices'"
                                    (click)="disableCustomer()">No customer?</label>
                            </div>
                            <ng-container
                                *ngIf="autoGeneratedReplacement[mappedFormData.get(key)!.field] !== undefined else notAutoGenerated">
                                <input [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                    type="text"
                                    [(ngModel)]="autoGeneratedReplacement[mappedFormData.get(key)!.field].value"
                                    [formControlName]="mappedFormData.get(key)!.field">
                            </ng-container>
                            <ng-template #notAutoGenerated>
                                <ng-container [ngSwitch]="mappedFormData.get(key)?.inputType">
                                    <label *ngSwitchCase="'file'" class="file-upload">
                                        <input
                                            [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                            accept="image/*" [type]="mappedFormData.get(key)!.inputType"
                                            (change)="primeImage($event)">
                                        <fa-icon [ngClass]="file == null ? '' : 'success'"
                                            [icon]="icons.faCloudUpload" /> {{ file == null ? "Upload Image" : file.name
                                        }}
                                    </label>
                                    <ng-container *ngSwitchCase="'alternative-select'">
                                        <input autocomplete="off"
                                            [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                            [disabled]="disabled" (input)="filterDropSelect(key, $event, true)"
                                            type="text" [id]="key" (focus)="onInputFocus(key)" (blur)="onInputBlur(key)"
                                            [value]="alternativeSelectedData[key].selectData">
                                        <div class="drop-select"
                                            [ngClass]="selectOpen[key].opened ? 'input-visible' : 'input-hidden'">
                                            <p *ngFor="let option of alternativeSelectData[key].data"
                                                (click)="updateAlternativeSelectData(mappedFormData.get(key)!.field, option, key)">
                                                {{ option }}</p>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'select'">
                                        <select
                                            [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                            class="select-input" [formControlName]="mappedFormData.get(key)!.field">
                                            <option hidden disabled selected value> -- Select an option -- </option>
                                            <option *ngFor="let data of selectDataFromKey(key); let optionKey = index"
                                                [selected]="optionKey == 0">{{ data }}</option>
                                        </select>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'replacement'">
                                        <ng-container
                                            *ngIf="(key == 'Delivery Address' || key == 'Billing Address') && addressNotListedKeys.includes(key) else standardSelect">
                                            <div class="input-container">
                                                <label>Line 1</label>
                                                <input [disabled]="disabled" class="text" type="text"
                                                    (input)="updateAddressValues(key, 'line1', $event)">
                                            </div>
                                            <div class="input-container">
                                                <label>Line 2</label>
                                                <input [disabled]="disabled" class="text" type="text"
                                                    (input)="updateAddressValues(key, 'line2', $event)">
                                            </div>
                                            <div class="input-container">
                                                <label>Line 3</label>
                                                <input [disabled]="disabled" class="text" type="text"
                                                    (input)="updateAddressValues(key, 'line3', $event)">
                                            </div>
                                            <div class="input-container">
                                                <label>Postcode</label>
                                                <input [disabled]="disabled" class="text" type="text"
                                                    (input)="updateAddressValues(key, 'postcode', $event)">
                                            </div>
                                            <div class="footer-options">
                                                <div>
                                                    <label>Save address?</label>
                                                    <input [disabled]="disabled" type="checkbox"
                                                        (input)="updateAddressValues(key, 'save', $event)">
                                                </div>
                                                <button [disabled]="disabled" class="button" type="button"
                                                    (click)="addAddressToBook(key)">Add</button>
                                            </div>
                                        </ng-container>
                                        <ng-template #standardSelect>
                                            <div class="drop-select-container">
                                                <input autocomplete="off"
                                                    [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                                    [disabled]="disabled" (input)="filterDropSelect(key, $event, true)"
                                                    type="text" (focus)="onInputFocus(key)" (blur)="onInputBlur(key)"
                                                    [value]="selectedReplacementData[key]?.selectData">
                                                <div class="drop-select"
                                                    [ngClass]="selectOpen[key].opened ? 'input-visible' : 'input-hidden'">
                                                    <ng-container
                                                        *ngFor="let option of filteredReplacementData[key].data">
                                                        <p *ngIf="option.replacement != ''"
                                                            (click)="updateSelectedReplacementDataFromKey(option.id, option.replacement, key, mappedFormData.get(key)!.field, false)">
                                                            {{ option.replacement }}</p>
                                                    </ng-container>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'replacement-text'">
                                        <div class="drop-select-container">
                                            <input autocomplete="off"
                                                [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                                (input)="filterTextDropSelect(key, $event, mappedFormData.get(key)!.field)"
                                                type="text" (focus)="onInputFocus(key)" (blur)="onInputBlur(key)"
                                                [value]="selectedTextReplacementData[key]">
                                            <div class="drop-select"
                                                [ngClass]="selectOpen[key]?.opened ? 'input-visible' : 'input-hidden'">
                                                <ng-container *ngFor="let option of filteredReplacementData[key].data">
                                                    <p *ngIf="option != ''"
                                                        (click)="updateSelectedTextReplacementDataFromKey(option, key, mappedFormData.get(key)!.field)">
                                                        {{ option }}</p>
                                                </ng-container>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngSwitchCase="'textarea'">
                                        <quill-editor
                                            [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                            [styles]="{height: '300px', backgroundColor: 'white', borderRadius: '5px'}"
                                            [formControlName]="mappedFormData.get(key)!.field"></quill-editor>
                                    </ng-container>
                                    <input *ngSwitchDefault
                                        [class]="inputHasError(mappedFormData.get(key)!.field) ? 'error-input' : ''"
                                        [type]="mappedFormData.get(key)!.inputType"
                                        [formControlName]="mappedFormData.get(key)!.field">
                                </ng-container>
                            </ng-template>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="tableName == 'customer_payments' || tableName == 'supplier_payments'">
                        <div class="invoice-details-container">
                            <h3>Documents to reconcile</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Date</th>
                                            <th>Total</th>
                                            <th>Outstanding balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let invoice of invoiceDetails">
                                            <td>{{ tableName == 'customer_payments' ? invoice['title'] :
                                                invoice['reference'] }}</td>
                                            <td>{{ invoice['created_at'] | date: 'dd/MM/yyyy' }}</td>
                                            <td>{{ invoice['total'] | currency: 'GBP' }}</td>
                                            <td>{{ invoice['outstanding_balance'] | currency:
                                                'GBP' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </ng-container>
                    <div class="form-footer">
                        <ng-container *ngIf="!shouldDisplayItemWidget() else invoicedItems">
                            <button class="button" (click)="formSubmit(true)" type="submit">Submit</button>
                        </ng-container>
                        <ng-template #invoicedItems>
                            <button class="button" [ngClass]="invoiceCreated ? 'button-success' : ''"
                                (click)="formSubmit(false)" type="submit">
                                <ng-container *ngIf="invoiceCreated else invoiceNotCreated">
                                    <fa-icon [icon]="icons.faCheck" />
                                </ng-container>
                                <ng-template #invoiceNotCreated>
                                    Create
                                </ng-template>
                            </button>
                        </ng-template>
                        <ng-container *ngIf="formSettings.showAddMore">
                            <button class="button" (click)="formSubmit(false)" type="submit">Add more</button>
                        </ng-container>
                    </div>
                </form>
                <ng-container *ngIf="shouldDisplayItemWidget()">
                    <form class="form-container" [formGroup]="addItemForm">
                        <h1>Add Items</h1>
                        <div class="input-container replacement">
                            <label>Item Name <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                            <div class="drop-select-container">
                                <input (input)="filterDropSelect('Item ID', $event, false, 'item_id')" type="text"
                                    (focus)="onInputFocus('Item ID')" (blur)="onInputBlur('Item ID')"
                                    [value]="selectedReplacementData['Item ID']?.selectData" formControlName="item_id">
                                <div class="drop-select"
                                    [ngClass]="selectOpen['Item ID']?.opened ? 'input-visible' : 'input-hidden'"
                                    required>
                                    <p *ngFor="let option of filteredReplacementData['Item ID'].data"
                                        (click)="updateSelectedReplacementDataFromKey(option.id, option.replacement, 'Item ID', 'item_id', true)">
                                        {{ option.replacement }}</p>
                                </div>
                            </div>
                        </div>
                        <ng-container *ngIf="tableName == 'supplier_invoices'">
                            <div class="input-container number">
                                <label>Purchase Price <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                                <input class="number" type="number" formControlName="purchase_price">
                            </div>
                            <div class="input-container date">
                                <label>Purchase Date <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                                <input class="date" type="date" formControlName="purchase_date">
                            </div>
                            <div class="input-container date">
                                <label>Expiry Date <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                                <input class="date" type="date" formControlName="expiry_date">
                            </div>
                            <div class="input-container text">
                                <label>Barcode <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                                <input class="text" type="text" formControlName="barcode">
                            </div>
                            <div class="input-container select">
                                <label>Packing Format <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                                <select class="select-input" formControlName="packing_format">
                                    <option selected value="Individual">Individual</option>
                                    <option value="Box">Box</option>
                                    <option value="Pallet">Pallet</option>
                                </select>
                            </div>
                        </ng-container>
                        <div class="input-container number">
                            <label>Quantity <fa-icon class="asterisk" [icon]="icons.faAsterisk" /></label>
                            <input class="number" type="number" formControlName="quantity">
                        </div>
                        <ng-container *ngIf="tableName == 'invoices'">
                            <div class="input-container number">
                                <label>Discount</label>
                                <input class="number" type="number" formControlName="discount">
                            </div>
                        </ng-container>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <th>Item Name</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <ng-container *ngIf="tableName == 'invoices'">
                                        <th>Discount</th>
                                        <th>VAT</th>
                                        <th>Total</th>
                                    </ng-container>
                                    <ng-container *ngIf="tableName == 'supplier_invoices'">
                                        <th>Purchase Date</th>
                                        <th>Expiry Date</th>
                                        <th>Packing Format</th>
                                        <th>Barcode</th>
                                    </ng-container>
                                </thead>
                                <tbody *ngIf="itemsList.length > 0">
                                    <tr *ngFor="let item of itemsList; let index = index">
                                        <td>{{ item.name ?? item.item_name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <ng-container *ngIf="tableName == 'invoices'">
                                            <td>{{ (item.price ?? 0) | currency:'GBP' }}
                                                {{ item.price == null ? '*' : '' }}</td>
                                            <td>{{ item.discount }}%</td>
                                            <td>{{ item.vat }}</td>
                                            <td>{{ item.total * ((100 - item.discount) / 100 ) | currency:'GBP' }}</td>
                                        </ng-container>
                                        <ng-container *ngIf="tableName == 'supplier_invoices'">
                                            <td>{{ item.purchase_price }}</td>
                                            <td>{{ item.purchase_date }}</td>
                                            <td>{{ item.expiry_date }}</td>
                                            <td>{{ item.packing_format }}</td>
                                            <td>{{ item.barcode }}</td>
                                        </ng-container>
                                        <td (click)="deleteRow(itemsList[index].id)">
                                            <fa-icon [icon]="icons.faX" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="form-footer">
                            <div>
                                <fa-icon [icon]="icons.faAsterisk" />
                                <p>Indicates no price for this customer type</p>
                            </div>
                            <div>
                                <button *ngIf="shouldDisplayItemWidget()" (click)="addItem($event)" class="button">Add
                                    invoiced items</button>
                                <button (click)="close()" class="button">Save</button>
                            </div>
                        </div>
                    </form>
                </ng-container>
            </ng-container>
            <ng-template #loading>
                <div class="loading-container">
                    <fa-icon class="loading-icon" [icon]="icons.faSpinner" spinPulse [spin]="true" />
                </div>
            </ng-template>
        </div>
    </div>
</div>