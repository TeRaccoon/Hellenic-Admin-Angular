<div class="container" [class]="formState.visible ? 'visible' : 'hidden'">
  <div [class]="fullscreen() ? 'content-fullscreen content' : 'content'">
    <div class="header-section">
      <h1>Adding...</h1>
      <div class="popup-options">
        <a (click)="minimize()">
          <fa-icon class="icons.fa-icon" [icon]="icons.minus" />
        </a>
        <a (click)="hide()">
          <fa-icon class="icons.fa-icon" [icon]="icons.faX" />
        </a>
      </div>
    </div>
    <div class="content-section">
      @if (formData && formState.loaded) {
        <form [formGroup]="addForm" class="form-container">
          @if (fullscreen()) {
            <h1>{{ "Adding Invoices" }}</h1>
          }
          @if (formState.error && formState.submitted) {
            <div class="error-section">{{ formState.error }}</div>
          }
          @if (tableName == "invoices") {
            <div class="input-container">
              <label>Sale type</label>
              <select
                (change)="changeSaleType($event)"
                class="select-input"
                [disabled]="!saleTypeEnabled"
              >
                <option [selected]="saleType == SaleType.Invoice">
                  {{ SaleType.Invoice }}
                </option>
                <option [selected]="saleType == SaleType.Cash">
                  {{ SaleType.Cash }}
                </option>
              </select>
            </div>
          }
          @for (key of mappedFormDataKeys; track key) {
            @if (canDisplayInputField(key)) {
              <div
                class="input-container"
                [ngClass]="mappedFormData.get(key)?.inputType"
              >
                <div class="label-container">
                  <label
                    >{{ key }}
                    @if (mappedFormData.get(key)?.required) {
                      <fa-icon class="asterisk" [icon]="icons.faAsterisk" />
                    }
                  </label>
                  @if (
                    (key == "Delivery Address" || key == "Billing Address") &&
                    !addressNotListedKeys.includes(key)
                  ) {
                    <label class="label-link" (click)="addressNotListed(key)"
                      ><a>Address not listed?</a></label
                    >
                  }
                  @if (key == "Customer Name" && tableName == "invoices") {
                    <label class="label-link" (click)="disableCustomer()"
                      >No customer?</label
                    >
                  }
                </div>
                @if (
                  autoGeneratedReplacement[mappedFormData.get(key)!.field] !==
                  undefined
                ) {
                  <input
                    [class]="
                      inputHasError(mappedFormData.get(key)!.field)
                        ? 'error-input'
                        : ''
                    "
                    type="text"
                    [(ngModel)]="
                      autoGeneratedReplacement[mappedFormData.get(key)!.field]
                        .value
                    "
                    [formControlName]="mappedFormData.get(key)!.field"
                  />
                } @else {
                  @switch (mappedFormData.get(key)?.inputType) {
                    @case ("file") {
                      <label class="file-upload">
                        <input
                          [class]="
                            inputHasError(mappedFormData.get(key)!.field)
                              ? 'error-input'
                              : ''
                          "
                          accept="image/*"
                          [type]="mappedFormData.get(key)!.inputType"
                          (change)="primeImage($event)"
                        />
                        <fa-icon
                          [ngClass]="file == null ? '' : 'success'"
                          [icon]="icons.faCloudUpload"
                        />
                        {{
                          file == null
                            ? "Upload
            Image"
                            : file.name
                        }}
                        <label class="upload-size-warning">(8mb max)</label>
                      </label>
                    }
                    @case ("alternative-select") {
                      <input
                        autocomplete="off"
                        [class]="
                          inputHasError(mappedFormData.get(key)!.field)
                            ? 'error-input'
                            : ''
                        "
                        [disabled]="disabled"
                        (input)="filterDropSelect(key, $event, true)"
                        type="text"
                        [id]="key"
                        (focus)="onInputFocus(key)"
                        (blur)="onInputBlur(key)"
                        [value]="alternativeSelectedData[key].selectData"
                      />
                      <div
                        class="drop-select"
                        [ngClass]="
                          selectOpen[key].opened
                            ? 'input-visible'
                            : 'input-hidden'
                        "
                      >
                        @for (
                          option of alternativeSelectData[key].data;
                          track option
                        ) {
                          <p
                            (click)="
                              updateAlternativeSelectData(
                                mappedFormData.get(key)!.field,
                                option,
                                key
                              )
                            "
                          >
                            {{ option }}
                          </p>
                        }
                      </div>
                    }
                    @case ("select") {
                      <select
                        [class]="
                          inputHasError(mappedFormData.get(key)!.field)
                            ? 'error-input'
                            : ''
                        "
                        class="select-input"
                        [formControlName]="mappedFormData.get(key)!.field"
                      >
                        <option hidden disabled selected value>
                          -- Select an option --
                        </option>
                        @for (
                          data of selectDataFromKey(key);
                          track data;
                          let optionKey = $index
                        ) {
                          <option [selected]="optionKey == 0">
                            {{ data }}
                          </option>
                        }
                      </select>
                    }
                    @case ("replacement") {
                      @if (
                        (key == "Delivery Address" ||
                          key == "Billing Address") &&
                        addressNotListedKeys.includes(key)
                      ) {
                        <app-invoice-address
                          [disabled]="disabled"
                          [key]="key"
                          (addAddressToBookEmitter)="addAddressToBook($event)"
                          (updateAddressValuesEmitter)="
                            updateAddressValues($event)
                          "
                        />
                      } @else {
                        <div class="drop-select-container">
                          <input
                            autocomplete="off"
                            [class]="
                              inputHasError(mappedFormData.get(key)!.field)
                                ? 'error-input'
                                : ''
                            "
                            [disabled]="disabled"
                            (input)="filterDropSelect(key, $event, true)"
                            type="text"
                            (focus)="onInputFocus(key)"
                            (blur)="onInputBlur(key)"
                            [value]="selectedReplacementData[key]?.selectData"
                          />
                          <div
                            class="drop-select"
                            [ngClass]="
                              selectOpen[key].opened
                                ? 'input-visible'
                                : 'input-hidden'
                            "
                          >
                            @if (
                              filteredReplacementData[key].data.length == 0
                            ) {
                              <p>Nothing to show here!</p>
                            } @else {
                              @for (
                                option of filteredReplacementData[key].data;
                                track option
                              ) {
                                @if (option.replacement != "") {
                                  <p
                                    (click)="
                                      updateSelectedReplacementDataFromKey(
                                        option.id,
                                        option.replacement,
                                        key,
                                        mappedFormData.get(key)!.field,
                                        false
                                      )
                                    "
                                  >
                                    {{ option.replacement }}
                                  </p>
                                }
                              }
                            }
                          </div>
                        </div>
                      }
                    }
                    @case ("replacement-text") {
                      <div class="drop-select-container">
                        <input
                          autocomplete="off"
                          [class]="
                            inputHasError(mappedFormData.get(key)!.field)
                              ? 'error-input'
                              : ''
                          "
                          (input)="
                            filterTextDropSelect(
                              key,
                              $event,
                              mappedFormData.get(key)!.field
                            )
                          "
                          type="text"
                          (focus)="onInputFocus(key)"
                          (blur)="onInputBlur(key)"
                          [value]="selectedTextReplacementData[key]"
                        />
                        <div
                          class="drop-select"
                          [ngClass]="
                            selectOpen[key]?.opened
                              ? 'input-visible'
                              : 'input-hidden'
                          "
                        >
                          @for (
                            option of filteredReplacementData[key].data;
                            track option
                          ) {
                            @if (option != "") {
                              <p
                                (click)="
                                  updateSelectedTextReplacementDataFromKey(
                                    option,
                                    key,
                                    mappedFormData.get(key)!.field
                                  )
                                "
                              >
                                {{ option }}
                              </p>
                            }
                          }
                        </div>
                      </div>
                    }
                    @case ("textarea") {
                      <quill-editor
                        [class]="
                          inputHasError(mappedFormData.get(key)!.field)
                            ? 'error-input'
                            : ''
                        "
                        [styles]="{
                          height: '300px',
                          backgroundColor: 'white',
                          borderRadius: '5px'
                        }"
                        [formControlName]="mappedFormData.get(key)!.field"
                      ></quill-editor>
                    }
                    @default {
                      <input
                        [class]="
                          inputHasError(mappedFormData.get(key)!.field)
                            ? 'error-input'
                            : ''
                        "
                        [type]="mappedFormData.get(key)!.inputType"
                        [formControlName]="mappedFormData.get(key)!.field"
                        (change)="inputChanged(mappedFormData.get(key)!.field)"
                      />
                    }
                  }
                }
              </div>
            }
          }
          @if (
            tableName == "customer_payments" || tableName == "supplier_payments"
          ) {
            <div class="invoice-details-container">
              <h3>Documents to reconcile</h3>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Date</th>
                      <th>Total</th>
                      <th>Outstanding balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (invoice of invoiceDetails; track invoice) {
                      <tr>
                        <td>
                          {{
                            tableName == "customer_payments"
                              ? invoice["title"]
                              : invoice["reference"]
                          }}
                        </td>
                        <td>
                          {{ invoice["created_at"] | date: "dd/MM/yyyy" }}
                        </td>
                        <td>{{ invoice["total"] | currency: "GBP" }}</td>
                        <td>
                          {{ invoice["outstanding_balance"] | currency: "GBP" }}
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }
          <div class="form-footer">
            @if (!shouldDisplayItemWidget()) {
              <button class="button" (click)="formSubmit(true)" type="submit">
                Submit
              </button>
            } @else {
              <button
                class="button"
                [ngClass]="invoiceCreated ? 'button-success' : ''"
                (click)="formSubmit(false)"
                type="submit"
              >
                @if (invoiceCreated) {
                  <fa-icon [icon]="icons.faCheck" />
                } @else {
                  Create
                }
              </button>
            }
            @if (formSettings.showAddMore) {
              <button class="button" (click)="formSubmit(false)" type="submit">
                Add more
              </button>
            }
          </div>
        </form>
        @if (shouldDisplayItemWidget()) {
          <form class="form-container" [formGroup]="addItemForm">
            <h1>Add Items</h1>
            <div class="input-container replacement">
              <label
                >Item Name <fa-icon class="asterisk" [icon]="icons.faAsterisk"
              /></label>
              <div class="drop-select-container">
                <input
                  [class]="itemInputHasError('item_id') ? 'error-input' : ''"
                  (input)="
                    filterDropSelect('Item ID', $event, false, 'item_id', true)
                  "
                  type="text"
                  (focus)="onInputFocus('Item ID')"
                  (blur)="onInputBlur('Item ID')"
                  [value]="selectedReplacementData['Item ID']?.selectData"
                  formControlName="item_id"
                />
                <div
                  class="drop-select"
                  [ngClass]="
                    selectOpen['Item ID']?.opened
                      ? 'input-visible'
                      : 'input-hidden'
                  "
                  required
                >
                  @for (
                    option of filteredReplacementData["Item ID"].data;
                    track option
                  ) {
                    <p
                      (click)="
                        updateSelectedReplacementDataFromKey(
                          option.id,
                          option.replacement,
                          'Item ID',
                          'item_id',
                          true
                        )
                      "
                    >
                      {{ option.replacement }}
                    </p>
                  }
                </div>
              </div>
            </div>
            @if (tableName == "supplier_invoices") {
              <div class="input-container number">
                <label
                  >Purchase Price
                  <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <input
                  [class]="itemInputHasError('quantity') ? 'error-input' : ''"
                  class="number"
                  type="number"
                  formControlName="purchase_price"
                />
              </div>
              <div class="input-container number">
                <label
                  >Quantity <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <input
                  [class]="itemInputHasError('quantity') ? 'error-input' : ''"
                  class="number"
                  type="number"
                  formControlName="quantity"
                />
              </div>
              <div class="input-container date">
                <label
                  >Purchase Date
                  <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <input
                  class="date"
                  type="date"
                  formControlName="purchase_date"
                />
              </div>
              <div class="input-container date">
                <label
                  >Expiry Date
                  <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <input class="date" type="date" formControlName="expiry_date" />
              </div>
              <div class="input-container text">
                <label
                  >Barcode <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <input class="text" type="text" formControlName="barcode" />
              </div>
              <div class="input-container replacement">
                <label
                  >Warehouse
                  <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <div class="drop-select-container">
                  <input
                    (input)="
                      filterDropSelect(
                        'Warehouse ID',
                        $event,
                        false,
                        'warehouse_id',
                        true
                      )
                    "
                    type="text"
                    (focus)="onInputFocus('Warehouse ID')"
                    (blur)="onInputBlur('Warehouse ID')"
                    [value]="
                      selectedReplacementData['Warehouse ID']?.selectData
                    "
                  />
                  <div
                    class="drop-select"
                    [ngClass]="
                      selectOpen['Warehouse ID']?.opened
                        ? 'input-visible'
                        : 'input-hidden'
                    "
                    required
                  >
                    @for (
                      option of filteredReplacementData["Warehouse ID"].data;
                      track option
                    ) {
                      <p
                        (click)="
                          updateSelectedReplacementDataFromKey(
                            option.id,
                            option.replacement,
                            'Warehouse ID',
                            'warehouse_id',
                            true
                          )
                        "
                      >
                        {{ option.replacement }}
                      </p>
                    }
                  </div>
                </div>
              </div>
              <div class="input-container select">
                <label
                  >Packing Format
                  <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <select class="select-input" formControlName="packing_format">
                  <option selected value="Individual">Individual</option>
                  <option value="Box">Box</option>
                  <option value="Pallet">Pallet</option>
                </select>
              </div>
            }
            @if (tableName == "invoices") {
              <div class="input-container number">
                <label
                  >Unit <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <select
                  [class]="itemInputHasError('unit') ? 'error-input' : ''"
                  class="select-input"
                  formControlName="unit"
                >
                  <option selected value="Unit">Individual</option>
                  <option value="Retail Box">Retail Box</option>
                  <option value="Box">Box</option>
                  <option value="Pallet">Pallet</option>
                </select>
              </div>
            }
            @if (tableName == "invoices") {
              <div class="input-container number">
                <label
                  >Quantity <fa-icon class="asterisk" [icon]="icons.faAsterisk"
                /></label>
                <input
                  [class]="itemInputHasError('quantity') ? 'error-input' : ''"
                  class="number"
                  type="number"
                  formControlName="quantity"
                />
              </div>
              <div class="input-container number">
                <label>Discount</label>
                <input
                  [class]="itemInputHasError('discount') ? 'error-input' : ''"
                  class="number"
                  type="number"
                  formControlName="discount"
                />
              </div>
            }
            <div class="table-container">
              <table>
                <thead>
                  <th>Item Name</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  @if (tableName == "invoices") {
                    <th>Unit</th>
                    <th>Discount</th>
                    <th>VAT</th>
                    <th>Total</th>
                  }
                  @if (tableName == "supplier_invoices") {
                    <th>Purchase Date</th>
                    <th>Expiry Date</th>
                    <th>Packing Format</th>
                    <th>Barcode</th>
                  }
                </thead>
                @if (itemsList.length > 0 && itemsList[0] != null) {
                  <tbody>
                    @for (item of itemsList; track item; let index = $index) {
                      <tr>
                        <td>{{ item.name ?? item.item_name }}</td>
                        <td>{{ item.quantity }}</td>
                        @if (tableName == "invoices") {
                          <td>
                            {{ item.price ?? 0 | currency: "GBP" }}
                            {{
                              item.price == null || item.price == 0 ? "*" : ""
                            }}
                          </td>
                          <td>
                            {{ item.unit == "Unit" ? "Individual" : item.unit }}
                          </td>
                          <td>{{ item.discount }}%</td>
                          <td>{{ item.vat }}</td>
                          <td>
                            {{
                              item.net * ((100 - item.discount) / 100)
                                | currency: "GBP"
                            }}
                          </td>
                        }
                        @if (tableName == "supplier_invoices") {
                          <td>{{ item.purchase_price }}</td>
                          <td>{{ item.purchase_date }}</td>
                          <td>{{ item.expiry_date }}</td>
                          <td>{{ item.packing_format }}</td>
                          <td>{{ item.barcode }}</td>
                        }
                        <td (click)="deleteRow(itemsList[index].id)">
                          <fa-icon [icon]="icons.faX" />
                        </td>
                      </tr>
                    }
                    @if (tableName == "invoices") {
                      <tr>
                        <td colspan="5">Total (inc. delivery)</td>
                        <td>{{ invoiceTotal | currency: "GBP" }}</td>
                      </tr>
                    }
                    @if (tableName == "supplier_invoices") {
                      <tr>
                        <td colspan="6">Total</td>
                        <td>{{ invoiceTotal | currency: "EUR" }}</td>
                      </tr>
                    }
                  </tbody>
                }
              </table>
            </div>
            <div class="form-footer">
              @if (shouldDisplayPriceWarning()) {
                <div>
                  <fa-icon [icon]="icons.faAsterisk" />
                  <p>Indicates no price for this customer type</p>
                </div>
              }
              <div>
                @if (shouldDisplayItemWidget()) {
                  <button (click)="addItem($event)" class="button">
                    Add invoiced items
                  </button>
                }
                <button (click)="close()" class="button">Save</button>
              </div>
            </div>
          </form>
        }
      } @else {
        <div class="loading-container">
          <fa-icon
            class="loading-icon"
            [icon]="icons.faSpinner"
            spinPulse
            [spin]="true"
          />
        </div>
      }
      <ng-template #loading>
        <div class="loading-container">
          <fa-icon
            class="loading-icon"
            [icon]="icons.faSpinner"
            spinPulse
            [spin]="true"
          />
        </div>
      </ng-template>
    </div>
  </div>
</div>
