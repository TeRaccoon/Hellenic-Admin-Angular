<div class="container" [class.hidden]="!formState.visible">
  <div [class]="fullscreen() ? 'content-fullscreen content' : 'content'">
    <div class="header-section">
      <h1>Create New {{ displayTableName }}</h1>
      <div class="popup-options">
        <a (click)="minimize()">
          <fa-icon class="icons.fa-icon" [icon]="icons.minus" />
        </a>
        <a (click)="hide()">
          <fa-icon class="icons.fa-icon" [icon]="icons.x" />
        </a>
      </div>
    </div>
    <div class="content-section">
      @if (formData && formState.loaded) {
        <form [formGroup]="addForm" class="form-container">
          @if (formState.error && formState.submitted) {
            <div class="error-section">{{ formState.error }}</div>
          }
          @if (tableName === 'invoices') {
            <div class="input-container">
              <label>Sale type</label>
              <select (change)="changeSaleType($event)" class="select-input" [disabled]="!saleTypeEnabled">
                <option [selected]="saleType === SaleType.Invoice">
                  {{ SaleType.Invoice }}
                </option>
                <option [selected]="saleType === SaleType.Cash">
                  {{ SaleType.Cash }}
                </option>
              </select>
            </div>
          }
          @for (key of mappedFormDataKeys; track key) {
            @if (canDisplayInputField(key)) {
              <div class="input-container" [ngClass]="mappedFormData.get(key)?.inputType">
                <div class="label-container">
                  <label
                    >{{ key }}
                    @if (mappedFormData.get(key)?.required) {
                      <fa-icon class="asterisk" [icon]="icons.asterisk" />
                    }
                  </label>
                  @if (shouldDisplayAddressNotListed(key)) {
                    <label class="label-link" (click)="addressNotListed(key)"><a>Address not listed?</a></label>
                  }
                  @if (key === 'Customer Name' && tableName === 'invoices') {
                    <label class="label-link" (click)="disableCustomer()">No customer?</label>
                  }
                </div>
                @if (autoGeneratedReplacement[mappedFormData.get(key)!.field] !== undefined) {
                  <input
                    [class]="inputHasError(mappedFormData.get(key)!.field)"
                    type="text"
                    [(ngModel)]="autoGeneratedReplacement[mappedFormData.get(key)!.field].value"
                    [formControlName]="mappedFormData.get(key)!.field"
                  />
                } @else {
                  @switch (mappedFormData.get(key)?.inputType) {
                    @case ('file') {
                      <app-file-upload
                        [class]="inputHasError(mappedFormData.get(key)!.field)"
                        [file]="file"
                        (primeImageEmitter)="primeImage($event)"
                      />
                    }
                    @case ('alternative-select') {
                      <app-dropselect
                        [selectData]="dropSelectData.alternative[key].selectData"
                        [replacementData]="alternativeSelectData[key].data"
                        [disabled]="disabled"
                        [class]="inputHasError(mappedFormData.get(key)!.field)"
                        [field]="mappedFormData.get(key)!.field"
                        [alternative]="true"
                        [text]="true"
                        [key]="key"
                        (updateText)="updateAlternativeSelectDataFromKeyEvent($event)"
                      />
                    }
                    @case ('select') {
                      <select
                        [class]="inputHasError(mappedFormData.get(key)!.field)"
                        class="select-input"
                        [formControlName]="mappedFormData.get(key)!.field"
                      >
                        <option hidden disabled selected value>-- Select an option --</option>
                        @for (data of selectDataFromKey(key); track data; let optionKey = $index) {
                          <option [selected]="optionKey === 0">
                            {{ data }}
                          </option>
                        }
                      </select>
                    }
                    @case ('replacement') {
                      @if (
                        (key === 'Delivery Address' || key === 'Billing Address') && addressNotListedKeys.includes(key)
                      ) {
                        <app-invoice-address
                          [disabled]="disabled"
                          [key]="key"
                          (addAddressToBookEmitter)="addAddressToBook($event)"
                          (updateAddressValuesEmitter)="updateAddressValues($event)"
                        />
                      } @else {
                        <app-dropselect
                          [selectData]="dropSelectData.selected[key]?.selectData ?? ''"
                          [replacementData]="replacementData[key]"
                          [disabled]="disabled"
                          [class]="inputHasError(mappedFormData.get(key)!.field)"
                          [field]="mappedFormData.get(key)!.field"
                          [alternative]="false"
                          [key]="key"
                          (update)="updateSelectedReplacementDataFromKeyEvent($event)"
                        />
                      }
                    }
                    @case ('replacement-text') {
                      <app-dropselect
                        [selectData]="dropSelectData.selectedText[key]"
                        [replacementData]="replacementData[key]"
                        [disabled]="disabled"
                        [class]="inputHasError(mappedFormData.get(key)!.field)"
                        [field]="mappedFormData.get(key)!.field"
                        [key]="key"
                        [text]="true"
                        (updateText)="updateSelectedTextReplacementDataFromKeyEvent($event)"
                      />
                    }
                    @case ('textarea') {
                      <quill-editor
                        [class]="inputHasError(mappedFormData.get(key)!.field)"
                        [styles]="{
                          height: '300px',
                          backgroundColor: 'white',
                          borderRadius: '5px'
                        }"
                        [formControlName]="mappedFormData.get(key)!.field"
                      ></quill-editor>
                    }
                    @default {
                      <input
                        [class]="inputHasError(mappedFormData.get(key)!.field)"
                        [type]="mappedFormData.get(key)!.inputType"
                        [formControlName]="mappedFormData.get(key)!.field"
                        (change)="inputChanged(mappedFormData.get(key)!.field)"
                      />
                    }
                  }
                }
              </div>
            }
          }
          @if ((tableName === 'customer_payments' || tableName === 'supplier_payments') && invoicesDetails.length > 0) {
            <app-documents-to-reconcile [invoicesDetails]="invoicesDetails" [tableName]="tableName" />
          }
          <app-form-footer
            [success]="invoiceCreated"
            [addMore]="formSettings.showAddMore"
            [withWidget]="shouldDisplayItemWidget()"
            (formSubmit)="formSubmit()"
          />
        </form>
        @if (shouldDisplayItemWidget()) {
          <form class="form-container left-form" [formGroup]="addItemForm">
            <div class="input-container replacement">
              <label>Item Name <fa-icon class="asterisk" [icon]="icons.asterisk" /></label>
              <app-dropselect
                [selectData]="dropSelectData.selected['Item ID']?.selectData ?? ''"
                [replacementData]="replacementData['Item ID']"
                [class]="itemInputHasError('item_id')"
                [field]="'item_id'"
                [alternative]="true"
                [key]="'Item ID'"
                (update)="updateSelectedReplacementDataFromKeyEvent($event)"
              />
            </div>
            @if (tableName === 'supplier_invoices') {}
            @if (tableName === 'invoices') {
              <div class="input-container number">
                <label>Unit <fa-icon class="asterisk" [icon]="icons.asterisk" /></label>
                <select [class]="itemInputHasError('unit')" class="select-input" formControlName="unit">
                  <option selected value="Unit">Individual</option>
                  <option value="Retail Box">Retail Box</option>
                  <option value="Box">Box</option>
                  <option value="Pallet">Pallet</option>
                </select>
              </div>
              <div class="input-container number">
                <label>Quantity <fa-icon class="asterisk" [icon]="icons.asterisk" /></label>
                <input
                  [class]="itemInputHasError('quantity')"
                  class="number"
                  type="number"
                  formControlName="quantity"
                />
              </div>
              <div class="input-container number">
                <label>Discount</label>
                <input
                  [class]="itemInputHasError('discount')"
                  class="number"
                  type="number"
                  formControlName="discount"
                />
              </div>
            }
            @if (invoiceId !== null) {
              <app-form-items-table [tableName]="tableName" [invoiceId]="invoiceId" />
            }

            @if (shouldDisplayPriceWarning()) {
              <div class="warning-box">
                <fa-icon [icon]="icons.asterisk" />
                <p>Indicates no price for this customer type</p>
              </div>
            }
            <div class="form-footer">
              @if (shouldDisplayItemWidget()) {
                <button (click)="addItem($event)" class="button">Add invoiced items</button>
              }
              <button (click)="close()" class="button">Save</button>
            </div>
          </form>
        }
      }
    </div>
  </div>
</div>
